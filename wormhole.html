<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wormhole Player</title>
  <style>
    :root{
      --bg:#05060a;
      --card:#0b0f17;
      --text:#e8f0ff;
      --muted:#9bb0ff;
      --accent:#6c9eff;
      --glow: 0 0 20px rgba(108,158,255,.35), 0 0 60px rgba(108,158,255,.15);
    }

    *{box-sizing:border-box;}
    html,body{height:100%; margin:0;}
    body{
      overflow:hidden;
      background: radial-gradient(1200px 800px at 10% 10%, #0a0f1e 0%, var(--bg) 50%, #000 100%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    .screen{
      position:fixed; inset:0; display:grid; place-items:center; padding:24px;
    }
    .hidden{display:none !important;}

    .card{
      width:min(760px, 92vw);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      border-radius:24px;
      padding:28px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px; border-radius:26px; padding:2px;
      background: conic-gradient(from 180deg at 50% 50%, #6c9eff33, transparent 30%, #00e7ff33 60%, transparent 85%, #6c9eff33);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
      filter: blur(8px);
      opacity:.7;
    }

    h1{
      margin:0 0 6px;
      font-size: clamp(28px, 5vw, 56px);
      letter-spacing:.2px;
      line-height:1.05;
      background: linear-gradient(90deg, #c7d8ff, #9bb0ff 40%, #9ff1ff 60%, #c7d8ff);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: var(--glow);
    }
    p.subtitle{margin:0 0 18px; color:var(--muted);}

    .drop{
      margin-top:12px;
      border:1.5px dashed rgba(255,255,255,.2);
      border-radius:18px;
      padding:22px;
      text-align:center;
      transition:.2s border-color, .2s background-color, .2s transform;
      background: rgba(255,255,255,.02);
    }
    .drop.dragover{
      border-color:#9ff1ff;
      background: rgba(159,241,255,.06);
      transform: translateY(-2px);
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      justify-content:center;
      margin-top:16px;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, #162033, #0f1524);
      padding:12px 16px;
      border-radius:14px;
      color:var(--text);
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
      box-shadow: var(--glow);
      transition: .15s transform, .2s box-shadow, .2s background-color;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 0 0 2px rgba(159,241,255,.25), var(--glow);}
    .btn:active{ transform: translateY(0);}

    .hint{font-size:13px; color:#c9d6ffb0; margin-top:10px;}

    footer{
      text-align:center; margin-top:16px; font-size:12px; color:#93a6ff90;
    }

    canvas{ display:block; width:100vw; height:100vh; }

    .hud{
      position:fixed; top:12px; left:12px;
      padding:8px 12px;
      border-radius:12px;
      font-size:13px; color:#d9e6ff;
      background:rgba(10,15,30,.35);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      pointer-events:none;
    }

    /* Watermark */
    #watermark{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      font-size:32px; color:#fff; text-shadow:0 0 10px #00f0ff, 0 0 20px #00f0ff;
      opacity:0; pointer-events:none; transition:opacity .2s;
    }

    /* Color selector */
    .color-selector{
      position:fixed; top:12px; right:12px; display:flex; gap:6px;
    }
    .color-btn{
      padding:6px 12px; border-radius:6px; border:none; cursor:pointer; font-size:12px;
      font-weight:600;
    }
  </style>
</head>
<body>
  <section id="start" class="screen">
    <div class="card">
      <h1>Wormhole Player</h1>
      <p class="subtitle">Drop a track into the void and ride the star tunnel. When it starts, we’ll jump in the <strong>Wormhole</strong>. Press <strong>Esc</strong> to stop and return.</p>
      <p class="subtitle"><strong>Fullscreen for the best experience</strong></p>

      <div id="drop" class="drop">
        <div>Drag & drop an audio file here</div>
        <div class="hint">MP3, WAV, AAC… Most formats work</div>
      </div>

      <div class="actions">
        <label class="btn" for="file">Choose an audio file</label>
        <input id="file" type="file" hidden />
      </div>

      <div id="confirm-container" class="actions" style="display:none; flex-direction:column; align-items:center;">
        <div style="margin-bottom:10px; color:var(--muted); font-size:15px;">You sure to play audio?</div>
        <button id="confirm-play" class="btn">Confirm</button>
      </div>

      <footer>Tip: Some browsers block audio until you interact — picking a file counts.</footer>
    </div>
  </section>

  <canvas id="wormhole"></canvas>
  <div id="hud" class="hud hidden">Esc to exit • Space to pause/resume</div>
  <div id="watermark">© NoahLi404</div>

  <div class="color-selector">
    <button class="color-btn" data-mode="default">Default</button>
    <button class="color-btn" data-mode="neon">Neon</button>
    <button class="color-btn" data-mode="rainbow">Rainbow</button>
  </div>

      <div id="star-count-container" style="position:fixed; bottom:18px; right:18px; background:rgba(10,15,30,.35); border-radius:12px; padding:10px 16px; border:1px solid rgba(255,255,255,.12); box-shadow: var(--glow); z-index:10; display:flex; align-items:center; gap:8px;">
        <label for="star-count" style="color:var(--muted); font-size:14px;">Stars:</label>
        <input id="star-count" type="number" min="10" max="10000" value="900" style="width:70px; border-radius:6px; border:1px solid #6c9eff44; padding:4px 8px; font-size:14px; background:rgba(255,255,255,.07); color:var(--text); outline:none;" />
      </div>

  <script src="https://cdn.jsdelivr.net/npm/web-audio-beat-detector"></script>
  <script>
    const startScreen = document.getElementById('start');
    const dropZone = document.getElementById('drop');
    const fileInput = document.getElementById('file');
    const canvas = document.getElementById('wormhole');
    const ctx = canvas.getContext('2d');
    const hud = document.getElementById('hud');
    const watermark = document.getElementById('watermark');
    const colorBtns = document.querySelectorAll('.color-btn');

    let audioCtx, audio, source, analyser, dataArray, bpm = 120;
    let stars = [], numStars = 900;
    let animId = null;
    let playing = false;
    let colorMode = 'default';

    function resize(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function initStars(){
      stars = [];
      for(let i=0;i<numStars;i++){
        stars.push({
          x: Math.random()*canvas.width - canvas.width/2,
          y: Math.random()*canvas.height - canvas.height/2,
          z: Math.random()*canvas.width,
          pz: 0
        });
      }
    }
    initStars();

    // Star count input handler
    const starCountInput = document.getElementById('star-count');
    starCountInput.addEventListener('change', ()=>{
      let val = parseInt(starCountInput.value, 10);
      if(isNaN(val) || val < 10) val = 10;
      if(val > 10000) val = 10000;
      numStars = val;
      starCountInput.value = val;
      initStars();
    });

    colorBtns.forEach(btn=>{
      btn.addEventListener('click', ()=> colorMode = btn.dataset.mode);
    });

    let pendingFile = null;
    fileInput.addEventListener('change', e=>{
      const file = e.target.files?.[0];
      if(file) showConfirm(file);
    });

    ['dragenter','dragover'].forEach(evt=>{
      dropZone.addEventListener(evt,e=>{
        e.preventDefault(); e.stopPropagation(); dropZone.classList.add('dragover');
      });
    });

    ['dragleave','drop'].forEach(evt=>{
      dropZone.addEventListener(evt,e=>{
        e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('dragover');
      });
    });

    dropZone.addEventListener('drop', e=>{
      const file = e.dataTransfer.files?.[0];
      if(file) showConfirm(file);
    });
    function showConfirm(file) {
      pendingFile = file;
      document.getElementById('confirm-container').style.display = '';
    }

    document.getElementById('confirm-play').addEventListener('click', () => {
      if (pendingFile) {
        document.getElementById('confirm-container').style.display = 'none';
        startVisualizer(pendingFile);
        pendingFile = null;
      }
    });

    async function startVisualizer(file){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audio){ audio.pause(); audio.src=''; }
        audio = new Audio(URL.createObjectURL(file));
        audio.crossOrigin = 'anonymous';
        audio.loop = false;

        if(source) try{ source.disconnect(); }catch{}
        if(analyser) try{ analyser.disconnect(); }catch{}

        source = audioCtx.createMediaElementSource(audio);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);

        try{
          const arrBuf = await file.arrayBuffer();
          const decoded = await audioCtx.decodeAudioData(arrBuf.slice(0));
          const result = await webAudioBeatDetector.guess(decoded);
          if(result && result.bpm) bpm = result.bpm;
        }catch(err){}

        await goFullscreen();
        startScreen.classList.add('hidden');
        hud.classList.remove('hidden');
        playing = true;

        await audio.play();
        if(audioCtx.state==='suspended') await audioCtx.resume();

        initStars();
        animate();

        setTimeout(()=>{
          watermark.style.opacity = '1';
          setTimeout(()=> watermark.style.opacity='0', 3000);
        },15000);

        audio.onended = exitToTitle;
      }catch(err){
        console.error(err);
        alert('Could not start playback.');
        exitToTitle();
      }
    }

let lastLoudness = 0;
let flashTimer = 0;
let shakeTimer = 0;

function triggerFlashEffect() {
  flashTimer = 7;
  shakeTimer = 10;
}

function drawFlash3DShake() {
  // Fullscreen white background while shining, with shining burst overlay
  ctx.save();
  let cx = canvas.width/2, cy = canvas.height/2;
  let shineAlpha = 0.7 * (flashTimer/7);

  // 1. Fullscreen solid white background
  ctx.globalAlpha = shineAlpha;
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // 2. Overlay: white radial gradient burst
  let grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, Math.max(canvas.width, canvas.height)/1.1);
  grad.addColorStop(0, 'rgba(255,255,255,1)');
  grad.addColorStop(0.18, 'rgba(255,255,255,0.85)');
  grad.addColorStop(0.45, 'rgba(255,255,255,0.35)');
  grad.addColorStop(1, 'rgba(255,255,255,0.01)');
  ctx.globalAlpha = shineAlpha;
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // 3. Intense white center burst
  ctx.globalAlpha = 0.32 * (flashTimer/7);
  ctx.beginPath();
  ctx.arc(cx, cy, 120 + (7-flashTimer)*8, 0, 2*Math.PI);
  ctx.fillStyle = 'white';
  ctx.shadowColor = '#fff';
  ctx.shadowBlur = 80;
  ctx.fill();

  // 4. White burst lines
  ctx.save();
  ctx.globalAlpha = 0.13 * (flashTimer/7);
  ctx.strokeStyle = 'white';
  ctx.shadowColor = '#fff';
  ctx.shadowBlur = 18;
  for(let i=0;i<32;i++){
    let angle = (i/32)*2*Math.PI + Math.random()*0.08;
    let len = Math.max(canvas.width, canvas.height) * (0.45 + Math.random()*0.18);
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx+Math.cos(angle)*len, cy+Math.sin(angle)*len);
    ctx.lineWidth = 2 + Math.random()*2;
    ctx.stroke();
  }
  ctx.restore();

  // 5. Soft white ripple circles
  ctx.save();
  ctx.globalAlpha = 0.08 * (flashTimer/7);
  ctx.strokeStyle = '#fff';
  ctx.shadowColor = '#fff';
  ctx.shadowBlur = 10;
  for(let r=100; r<Math.max(canvas.width,canvas.height)*0.8; r+=90){
    ctx.beginPath();
    ctx.arc(cx, cy, r + (7-flashTimer)*10, 0, 2*Math.PI);
    ctx.lineWidth = 2 + Math.random()*1.5;
    ctx.stroke();
  }
  ctx.restore();

  ctx.globalCompositeOperation = 'source-over';
  ctx.restore();
}

    function animate(){
      if(!playing) return;
      animId = requestAnimationFrame(animate);
      analyser.getByteFrequencyData(dataArray);

      let sum = 0;
      for(let i=0;i<dataArray.length;i++) sum+=dataArray[i];
      const loudness = sum/dataArray.length;


      // Pure screen shake
      if(shakeTimer > 0) {
        const shakeMag = 12 * (shakeTimer/10);
        ctx.save();
        ctx.translate((Math.random()-0.5)*shakeMag, (Math.random()-0.5)*shakeMag);
      }

      ctx.fillStyle = 'rgba(0,0,0,0.3)';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // Detect sudden energy change
      let sudden = Math.abs(loudness - lastLoudness) > 6;
      if(sudden) triggerFlashEffect();
      if(flashTimer > 0) {
        drawFlash3DShake();
        flashTimer--;
      }
      if(shakeTimer > 0) shakeTimer--;
      if(shakeTimer > 0) { ctx.restore(); }
      lastLoudness = loudness;

      const speed = 2 + (loudness/2) + (bpm/50);

      for(let i=0;i<stars.length;i++){
        const s = stars[i];
        s.z -= speed;
        if(s.z < 1){
            // Spawn star in a circle around the center
            let angle = Math.random() * 2 * Math.PI;
            let radius = Math.random() * canvas.width/2;
            s.x = radius * Math.cos(angle);
            s.y = radius * Math.sin(angle);
            s.z = canvas.width;
            s.pz = s.z;
        }

        const sx = (s.x/s.z)*canvas.width/2 + canvas.width/2;
        const sy = (s.y/s.z)*canvas.height/2 + canvas.height/2;
        const px = (s.x/s.pz)*canvas.width/2 + canvas.width/2;
        const py = (s.y/s.pz)*canvas.height/2 + canvas.height/2;
        s.pz = s.z;

        let color;
        switch(colorMode){
          case 'neon': color = `hsl(${(loudness*4)%360}, 100%, 60%)`; break;
          case 'rainbow': color = `hsl(${(i*4)%360}, 100%, 70%)`; break;
          default: color = `hsl(${(loudness*3) % 360}, 100%, 70%)`;
        }

        ctx.strokeStyle = color;
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(px,py);
        ctx.lineTo(sx,sy);
        ctx.stroke();
      }

      // Draw energy bar last so it's always on top
      ctx.save();
      ctx.font = '18px monospace';
      ctx.fillStyle = '#fff';
      ctx.globalAlpha = 0.85;
      let barX = 24, barY = canvas.height - 48;
      ctx.fillText('Energy: ' + loudness.toFixed(2), barX, barY);
      // Draw a bar
      ctx.fillStyle = '#6c9eff';
      ctx.globalAlpha = 0.5;
      ctx.fillRect(barX, barY+8, Math.min(loudness*3, canvas.width-60), 12);
      ctx.restore();
    }

    function exitToTitle(){
      if(animId) cancelAnimationFrame(animId);
      playing=false;
      if(audio){ audio.pause(); audio.src=''; audio=null; }
      startScreen.classList.remove('hidden');
      hud.classList.add('hidden');
      watermark.style.opacity = '0';
    }

    document.addEventListener('keydown', e=>{
      if(e.key==='Escape') exitToTitle();
      if(e.key===' ' && audio) { e.preventDefault(); audio.paused ? audio.play() : audio.pause(); }
    });

    async function goFullscreen(){
      if(!document.fullscreenElement){
        try{ await document.documentElement.requestFullscreen(); }catch{}
      }
    }
  </script>
</body>
</html>
